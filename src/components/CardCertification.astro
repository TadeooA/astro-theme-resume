
---
// src/components/EducationItem.astro
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'
import { cn } from '@/utils'

interface Props {
  as?: 'div' | 'a' | 'section' | 'article';
  class?: string;
  institution: string;
  degree: string;
  fieldOfStudy?: string;
  period: string;
  isCompleted?: boolean;
  grade?: string;
  icon?: string;
  imagePath?: string;
  altText?: string;
  imageClass?: string;
  href?: string;
  // Nuevas props para certificaciones
  isCertification?: boolean;
  credentialId?: string;
  credentialUrl?: string;
  issuerLogo?: string;
}

const {
  as: Tag = 'div',
  class: className,
  institution,
  degree,
  fieldOfStudy,
  period,
  isCompleted = true,
  grade,
  icon,
  imagePath,
  altText = `${institution} logo`,
  imageClass,
  href,
  // Nuevas props
  isCertification = false,
  credentialId,
  credentialUrl,
  issuerLogo
} = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/*.{jpeg,jpg,png,gif,svg}')

if (imagePath) {
  if (!images[imagePath]) {
    throw new Error(`"${imagePath}" does not exist in glob: "src/assets/*.{jpeg,jpg,png,gif,svg}"`)
  }
}

const containerClasses = cn(
  className,
  'relative rounded-2xl border-2 border-dashed bg-primary-foreground px-5 py-4',
  'transition-all hover:border-foreground/25 hover:shadow-sm',
  !isCompleted && 'border-yellow-400/50',
  href && 'hover:shadow-lg',
  isCertification && 'border-blue-400/30 hover:border-blue-400/50'
);
---

<Fragment>
  {Tag === 'a' || credentialUrl ? (
    <a 
      href={credentialUrl || href}
      class={containerClasses}
      target={credentialUrl ? "_blank" : undefined}
      rel={credentialUrl ? "noopener noreferrer" : undefined}
    >
      <div class="flex flex-col md:flex-row gap-4">
        {/* Prioridad: issuerLogo (para certificaciones) > imagePath > icon */}
        {(issuerLogo && isCertification) ? (
          <div class="flex-shrink-0 rounded-2xl">
            <img
              src={issuerLogo}
              alt={`${institution} logo`}
              class={cn('w-16 h-16 object-contain rounded-xl', imageClass)}
              loading="eager"
              width={64}
              height={64}
            />
          </div>
        ) : imagePath ? (
          <div class="flex-shrink-0">
            <Image
              src={images[imagePath]()}
              alt={altText}
              class={cn('w-16 h-16 object-contain rounded-lg', imageClass)}
              loading="eager"
              width={64}
              height={64}
            />
          </div>
        ) : icon ? (
          <div class="flex-shrink-0 flex items-center justify-center w-16 h-16 bg-primary/10 rounded-lg">
            <i class={cn(icon, 'text-2xl text-primary')}></i>
          </div>
        ) : null}

        <div class="flex-1 flex flex-col gap-y-1.5">
          <div class="flex flex-col gap-y-0.5">
            <h2 class="text-lg font-medium">{degree}</h2>
            <h2 class="text-muted-foreground font-semibold">{institution}</h2>
            {fieldOfStudy && <p class="text-sm text-muted-foreground">{fieldOfStudy}</p>}
            
            <div class="flex items-center gap-2 mt-1 flex-wrap">
              <span class="text-sm text-muted-foreground">{period}</span>
              {grade && (
                <span class="text-sm px-2 py-0.5 bg-primary/10 text-primary rounded-full">
                  {grade}
                </span>
              )}
              {!isCompleted && (
                <span class="text-sm px-2 py-0.5 bg-yellow-400/10 text-yellow-600 rounded-full">
                  En progreso
                </span>
              )}
              {isCertification && credentialId && (
                <span class="text-sm px-2 py-0.5 bg-blue-400/10 text-blue-600 rounded-full">
                  ID: {credentialId}
                </span>
              )}
              {isCertification && (
                <span class="text-sm px-2 py-0.5 bg-green-400/10 text-green-600 rounded-full">
                  Certificación
                </span>
              )}
            </div>
          </div>
          
          <div class="mt-2">
            <slot name="description" />
          </div>
          
          <slot />
        </div>
      </div>
    </a>
  ) : (
    <div class={containerClasses}>
      <div class="flex flex-col md:flex-row gap-4">
        {(issuerLogo && isCertification) ? (
          <div class="flex-shrink-0">
            <img
              src={issuerLogo}
              alt={`${institution} logo`}
              class={cn('w-16 h-16 object-contain rounded-lg', imageClass)}
              loading="eager"
              width={64}
              height={64}
            />
          </div>
        ) : imagePath ? (
          <div class="flex-shrink-0">
            <Image
              src={images[imagePath]()}
              alt={altText}
              class={cn('w-16 h-16 object-contain rounded-lg', imageClass)}
              loading="eager"
              width={64}
              height={64}
            />
          </div>
        ) : icon ? (
          <div class="flex-shrink-0 flex items-center justify-center w-16 h-16 bg-primary/10 rounded-lg">
            <i class={cn(icon, 'text-2xl text-primary')}></i>
          </div>
        ) : null}

        <div class="flex-1 flex flex-col gap-y-1.5">
          <div class="flex flex-col gap-y-0.5">
            <h1 class="text-lg font-medium">{degree}</h1>
            <h2 class="text-muted-foreground font-semibold">{institution}</h2>
            {fieldOfStudy && <p class="text-sm text-muted-foreground">{fieldOfStudy}</p>}
            
            <div class="flex items-center gap-2 mt-1 flex-wrap">
              <span class="text-sm text-muted-foreground">{period}</span>
              {grade && (
                <span class="text-sm px-2 py-0.5 bg-primary/10 text-primary rounded-full">
                  {grade}
                </span>
              )}
              {!isCompleted && (
                <span class="text-sm px-2 py-0.5 bg-yellow-400/10 text-yellow-600 rounded-full">
                  En progreso
                </span>
              )}
              {isCertification && credentialId && (
                <span class="text-sm px-2 py-0.5 bg-blue-400/10 text-blue-600 rounded-full">
                  ID: {credentialId}
                </span>
              )}
              {isCertification && (
                <span class="text-sm px-2 py-0.5 bg-green-400/10 text-green-600 rounded-full">
                  Certificación
                </span>
              )}
            </div>
          </div>
          
          <div class="mt-2">
            <slot name="description" />
          </div>
          
          <slot />
        </div>
      </div>
    </div>
  )}
</Fragment>